# 小红花家庭奖励系统 - 技术设计文档

## 1. 技术架构概述

### 1.1 整体架构
采用前后端分离的微服务架构，支持多端访问，具备高可用、高扩展性特点。

```
前端层 (多端)
├── Web端 (Vue3 + TypeScript)
├── 移动端 (UniApp跨平台)
├── 小程序 (微信/支付宝)
└── 管理后台 (Vue3 + Element Plus)

网关层
└── Spring Cloud Gateway (路由、鉴权、限流)

服务层 (微服务)
├── 用户服务 (User Service)
├── 红花服务 (Flower Service)
├── 任务服务 (Task Service)
├── 奖励服务 (Reward Service)
├── 消息服务 (Message Service)
├── 文件服务 (File Service)
├── 班级服务 (Class Service)
└── 日志服务 (Log Service)

数据层
├── MySQL (主数据库)
├── Redis (缓存)
├── MongoDB (日志存储)
└── OSS (文件存储)
```

### 1.2 技术栈选型

#### 1.2.1 后端技术栈
- **开发语言**: Java 17
- **框架**: Spring Boot 3.x + Spring Cloud 2022.x
- **数据库**: MySQL 8.0 + MyBatis Plus
- **缓存**: Redis 7.x
- **消息队列**: RabbitMQ
- **注册中心**: Nacos
- **网关**: Spring Cloud Gateway
- **认证授权**: Spring Security + JWT
- **API文档**: Knife4j (Swagger3)
- **监控**: Micrometer + Prometheus + Grafana

#### 1.2.2 前端技术栈
- **Web端**: Vue3 + TypeScript + Vite + Pinia
- **UI框架**: Element Plus / Ant Design Vue
- **移动端**: UniApp + Vue3 (支持小程序、App、H5)
- **状态管理**: Pinia
- **HTTP客户端**: Axios
- **构建工具**: Vite / Webpack

#### 1.2.3 运维技术栈
- **容器化**: Docker + Docker Compose
- **编排**: Kubernetes (可选)
- **CI/CD**: Jenkins / GitLab CI
- **日志**: ELK Stack (Elasticsearch + Logstash + Kibana)
- **APM**: SkyWalking

## 2. 系统架构设计

### 2.1 微服务拆分

#### 2.1.1 用户服务 (user-service)
**职责**: 用户管理、认证授权、角色权限
```java
模块划分:
├── UserController (用户CRUD)
├── AuthController (登录注册)
├── RoleController (角色管理)
├── PermissionController (权限管理)
├── FamilyController (家庭管理)
├── TeacherController (教师管理)
└── StudentController (学生管理)
```

#### 2.1.2 红花服务 (flower-service)
**职责**: 红花账户、流水记录、转账交易
```java
模块划分:
├── FlowerAccountController (红花账户)
├── FlowerTransactionController (交易记录)
├── FlowerTransferController (转账功能)
└── BlackFlowerController (黑花管理)
```

#### 2.1.3 任务服务 (task-service)
**职责**: 任务管理、执行记录、计时功能
```java
模块划分:
├── TaskController (任务CRUD)
├── TaskExecutionController (任务执行)
├── TaskTimerController (计时功能)
└── TaskStatisticsController (统计分析)
```

#### 2.1.4 奖励服务 (reward-service)
**职责**: 奖励商品、购买交易、第三方对接
```java
模块划分:
├── RewardController (奖励管理)
├── RewardPurchaseController (购买功能)
├── ThirdPartyController (第三方商品)
└── RewardUsageController (使用记录)
```

#### 2.1.5 消息服务 (message-service)
**职责**: 消息推送、通知管理、模板配置
```java
模块划分:
├── MessageController (消息管理)
├── NotificationController (通知推送)
├── TemplateController (模板配置)
└── MessageStatisticsController (消息统计)
```

#### 2.1.6 班级服务 (class-service)
**职责**: 班级管理、小组管理、班级任务
```java
模块划分:
├── ClassController (班级CRUD)
├── GroupController (小组管理)
├── ClassTaskController (班级任务)
├── ClassStatisticsController (班级统计)
└── ClassRankingController (班级排名)
```

#### 2.1.7 日志服务 (log-service)
**职责**: 成长日志、活动记录、时间线生成
```java
模块划分:
├── ActivityLogController (活动日志)
├── TimelineController (时间线管理)
├── MilestoneController (里程碑记录)
├── GrowthReportController (成长报告)
└── LogAnalyticsController (日志分析)
```

### 2.2 数据库设计

#### 2.2.1 用户模块表结构

```sql
-- 用户表
CREATE TABLE `user` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `username` varchar(50) NOT NULL UNIQUE COMMENT '用户名',
  `password` varchar(100) NOT NULL COMMENT '密码',
  `nickname` varchar(50) COMMENT '昵称',
  `avatar` varchar(200) COMMENT '头像',
  `phone` varchar(20) COMMENT '手机号',
  `email` varchar(100) COMMENT '邮箱',
  `role` varchar(20) NOT NULL COMMENT '角色:ADMIN,PARENT,CHILD',
  `status` tinyint DEFAULT 1 COMMENT '状态:0禁用,1启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 家庭表
CREATE TABLE `family` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '家庭名称',
  `description` text COMMENT '家庭描述',
  `creator_id` bigint NOT NULL COMMENT '创建者ID',
  `flower_total` int DEFAULT 0 COMMENT '红花总量',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 家庭成员关系表
CREATE TABLE `family_member` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `family_id` bigint NOT NULL COMMENT '家庭ID',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `role` varchar(20) NOT NULL COMMENT '家庭角色:PARENT,CHILD',
  `relation` varchar(20) COMMENT '关系:父亲,母亲,孩子等',
  `join_time` datetime DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_family_user` (`family_id`, `user_id`)
);

-- 学校表
CREATE TABLE `school` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '学校名称',
  `address` varchar(200) COMMENT '学校地址',
  `contact_phone` varchar(20) COMMENT '联系电话',
  `description` text COMMENT '学校描述',
  `flower_total` int DEFAULT 0 COMMENT '学校红花总量',
  `status` tinyint DEFAULT 1 COMMENT '状态:0禁用,1启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 班级表
CREATE TABLE `class` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `school_id` bigint NOT NULL COMMENT '学校ID',
  `name` varchar(100) NOT NULL COMMENT '班级名称',
  `grade` varchar(20) COMMENT '年级',
  `description` text COMMENT '班级描述',
  `teacher_id` bigint NOT NULL COMMENT '班主任ID',
  `max_students` int DEFAULT 50 COMMENT '最大学生数',
  `flower_pool` int DEFAULT 0 COMMENT '班级红花池',
  `status` tinyint DEFAULT 1 COMMENT '状态:0禁用,1启用',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 班级成员表
CREATE TABLE `class_member` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `class_id` bigint NOT NULL COMMENT '班级ID',
  `student_id` bigint NOT NULL COMMENT '学生ID',
  `student_number` varchar(20) COMMENT '学号',
  `join_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `status` tinyint DEFAULT 1 COMMENT '状态:0退出,1在读',
  UNIQUE KEY `uk_class_student` (`class_id`, `student_id`)
);

-- 学习小组表
CREATE TABLE `study_group` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `class_id` bigint NOT NULL COMMENT '班级ID',
  `name` varchar(50) NOT NULL COMMENT '小组名称',
  `description` varchar(200) COMMENT '小组描述',
  `leader_id` bigint COMMENT '组长ID',
  `max_members` int DEFAULT 6 COMMENT '最大成员数',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 小组成员表
CREATE TABLE `group_member` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `group_id` bigint NOT NULL COMMENT '小组ID',
  `student_id` bigint NOT NULL COMMENT '学生ID',
  `role` varchar(20) DEFAULT 'MEMBER' COMMENT '角色:LEADER,MEMBER',
  `join_time` datetime DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_group_student` (`group_id`, `student_id`)
);
```

#### 2.2.2 红花模块表结构

```sql
-- 红花账户表
CREATE TABLE `flower_account` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `user_id` bigint NOT NULL UNIQUE COMMENT '用户ID',
  `red_flower_balance` int DEFAULT 0 COMMENT '红花余额',
  `black_flower_balance` int DEFAULT 0 COMMENT '黑花余额',
  `total_earned` int DEFAULT 0 COMMENT '累计获得',
  `total_spent` int DEFAULT 0 COMMENT '累计消费',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 红花交易记录表
CREATE TABLE `flower_transaction` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `transaction_no` varchar(50) NOT NULL UNIQUE COMMENT '交易号',
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `type` varchar(20) NOT NULL COMMENT '交易类型:EARN,SPEND,TRANSFER_IN,TRANSFER_OUT',
  `flower_type` varchar(10) NOT NULL COMMENT '花朵类型:RED,BLACK',
  `amount` int NOT NULL COMMENT '交易数量',
  `balance_after` int NOT NULL COMMENT '交易后余额',
  `related_id` bigint COMMENT '关联业务ID',
  `related_type` varchar(20) COMMENT '关联业务类型:TASK,REWARD,TRANSFER',
  `description` varchar(200) COMMENT '交易描述',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP
);

-- 红花转账记录表
CREATE TABLE `flower_transfer` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `transfer_no` varchar(50) NOT NULL UNIQUE COMMENT '转账号',
  `from_user_id` bigint NOT NULL COMMENT '转出用户ID',
  `to_user_id` bigint NOT NULL COMMENT '转入用户ID',
  `amount` int NOT NULL COMMENT '转账数量',
  `status` varchar(20) DEFAULT 'SUCCESS' COMMENT '状态:SUCCESS,FAILED',
  `remark` varchar(200) COMMENT '备注',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP
);
```

#### 2.2.3 任务模块表结构

```sql
-- 任务表
CREATE TABLE `task` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `title` varchar(100) NOT NULL COMMENT '任务标题',
  `description` text COMMENT '任务描述',
  `creator_id` bigint NOT NULL COMMENT '创建者ID(家长/老师)',
  `assignee_id` bigint COMMENT '执行者ID(孩子/学生，个人任务时使用)',
  `family_id` bigint COMMENT '家庭ID(家庭任务)',
  `class_id` bigint COMMENT '班级ID(班级任务)',
  `group_id` bigint COMMENT '小组ID(小组任务)',
  `type` varchar(20) NOT NULL COMMENT '任务类型:STUDY,BEHAVIOR,HABIT',
  `scope` varchar(20) NOT NULL COMMENT '任务范围:FAMILY,CLASS,GROUP,INDIVIDUAL',
  `category` varchar(50) COMMENT '任务分类',
  `reward_flowers` int NOT NULL COMMENT '奖励红花数',
  `is_recurring` tinyint DEFAULT 0 COMMENT '是否循环:0否,1是',
  `recurring_rule` varchar(100) COMMENT '循环规则:DAILY,WEEKLY,CUSTOM',
  `start_time` datetime COMMENT '开始时间',
  `end_time` datetime COMMENT '结束时间',
  `status` varchar(20) DEFAULT 'ACTIVE' COMMENT '状态:ACTIVE,COMPLETED,CANCELLED',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 任务执行记录表
CREATE TABLE `task_execution` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `task_id` bigint NOT NULL COMMENT '任务ID',
  `executor_id` bigint NOT NULL COMMENT '执行者ID',
  `execution_date` date NOT NULL COMMENT '执行日期',
  `start_time` datetime COMMENT '开始时间',
  `end_time` datetime COMMENT '结束时间',
  `duration` int COMMENT '执行时长(秒)',
  `status` varchar(20) DEFAULT 'STARTED' COMMENT '状态:STARTED,PAUSED,COMPLETED,VERIFIED',
  `completion_proof` text COMMENT '完成证明',
  `verification_status` varchar(20) COMMENT '审核状态:PENDING,APPROVED,REJECTED',
  `verifier_id` bigint COMMENT '审核者ID',
  `verification_note` varchar(500) COMMENT '审核备注',
  `flowers_awarded` int DEFAULT 0 COMMENT '已奖励红花数',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 任务计时记录表
CREATE TABLE `task_timer` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `execution_id` bigint NOT NULL COMMENT '执行记录ID',
  `start_time` datetime NOT NULL COMMENT '开始时间',
  `end_time` datetime COMMENT '结束时间',
  `duration` int DEFAULT 0 COMMENT '计时时长(秒)',
  `status` varchar(20) DEFAULT 'RUNNING' COMMENT '状态:RUNNING,PAUSED,STOPPED',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 2.2.4 奖励模块表结构

```sql
-- 奖励商品表
CREATE TABLE `reward` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(100) NOT NULL COMMENT '奖励名称',
  `description` text COMMENT '奖励描述',
  `image_url` varchar(500) COMMENT '奖励图片',
  `creator_id` bigint NOT NULL COMMENT '创建者ID(家长)',
  `family_id` bigint NOT NULL COMMENT '家庭ID',
  `type` varchar(20) NOT NULL COMMENT '奖励类型:PHYSICAL,TIME,EXPERIENCE',
  `price` int NOT NULL COMMENT '所需红花数',
  `stock` int DEFAULT -1 COMMENT '库存数量(-1表示无限)',
  `duration` int COMMENT '时长(秒)，适用于时间类奖励',
  `validity_days` int COMMENT '有效期(天)',
  `third_party_url` varchar(500) COMMENT '第三方商品链接',
  `third_party_data` json COMMENT '第三方商品数据',
  `status` varchar(20) DEFAULT 'ACTIVE' COMMENT '状态:ACTIVE,INACTIVE',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 奖励购买记录表
CREATE TABLE `reward_purchase` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `purchase_no` varchar(50) NOT NULL UNIQUE COMMENT '购买订单号',
  `reward_id` bigint NOT NULL COMMENT '奖励ID',
  `buyer_id` bigint NOT NULL COMMENT '购买者ID(孩子)',
  `quantity` int DEFAULT 1 COMMENT '购买数量',
  `total_price` int NOT NULL COMMENT '总价(红花数)',
  `red_flowers_used` int NOT NULL COMMENT '使用红花数',
  `black_flowers_used` int NOT NULL COMMENT '使用黑花数',
  `status` varchar(20) DEFAULT 'PENDING' COMMENT '状态:PENDING,CONFIRMED,DELIVERED,COMPLETED',
  `purchase_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `confirm_time` datetime COMMENT '确认时间',
  `delivery_time` datetime COMMENT '发放时间',
  `expire_time` datetime COMMENT '过期时间'
);

-- 奖励使用记录表
CREATE TABLE `reward_usage` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `purchase_id` bigint NOT NULL COMMENT '购买记录ID',
  `user_id` bigint NOT NULL COMMENT '使用者ID',
  `start_time` datetime NOT NULL COMMENT '开始使用时间',
  `end_time` datetime COMMENT '结束使用时间',
  `planned_duration` int COMMENT '计划使用时长(秒)',
  `actual_duration` int COMMENT '实际使用时长(秒)',
  `overtime_duration` int DEFAULT 0 COMMENT '超时时长(秒)',
  `black_flowers_penalty` int DEFAULT 0 COMMENT '超时黑花惩罚',
  `status` varchar(20) DEFAULT 'USING' COMMENT '状态:USING,COMPLETED,OVERTIME',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

#### 2.2.5 成长日志模块表结构

```sql
-- 活动日志表
CREATE TABLE `activity_log` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `activity_type` varchar(30) NOT NULL COMMENT '活动类型:TASK_COMPLETE,FLOWER_EARN,REWARD_PURCHASE,ACHIEVEMENT_UNLOCK',
  `activity_scope` varchar(20) COMMENT '活动范围:FAMILY,CLASS,GROUP',
  `title` varchar(200) NOT NULL COMMENT '活动标题',
  `description` text COMMENT '活动描述',
  `related_id` bigint COMMENT '关联业务ID',
  `related_type` varchar(30) COMMENT '关联业务类型:TASK,REWARD,ACHIEVEMENT',
  `metadata` json COMMENT '扩展数据',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP
);

-- 里程碑记录表
CREATE TABLE `milestone` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `type` varchar(30) NOT NULL COMMENT '里程碑类型:FIRST_TASK,FLOWER_MILESTONE,CONSECUTIVE_DAYS',
  `title` varchar(100) NOT NULL COMMENT '里程碑标题',
  `description` text COMMENT '里程碑描述',
  `icon_url` varchar(200) COMMENT '图标URL',
  `badge_color` varchar(20) COMMENT '徽章颜色',
  `unlock_condition` varchar(200) COMMENT '解锁条件',
  `unlock_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `is_special` tinyint DEFAULT 0 COMMENT '是否特殊里程碑:0否,1是'
);

-- 成长报告表
CREATE TABLE `growth_report` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `report_type` varchar(20) NOT NULL COMMENT '报告类型:DAILY,WEEKLY,MONTHLY,YEARLY',
  `start_date` date NOT NULL COMMENT '开始日期',
  `end_date` date NOT NULL COMMENT '结束日期',
  `report_data` json NOT NULL COMMENT '报告数据',
  `summary` text COMMENT '报告摘要',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP
);

-- 家长/老师评价表
CREATE TABLE `evaluation` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `evaluator_id` bigint NOT NULL COMMENT '评价者ID(家长/老师)',
  `student_id` bigint NOT NULL COMMENT '被评价学生ID',
  `evaluation_type` varchar(20) NOT NULL COMMENT '评价类型:PARENT_COMMENT,TEACHER_COMMENT',
  `content` text NOT NULL COMMENT '评价内容',
  `tags` varchar(200) COMMENT '标签',
  `mood` varchar(20) COMMENT '情绪:HAPPY,PROUD,ENCOURAGING,CONCERNED',
  `related_activity_id` bigint COMMENT '关联活动ID',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP
);

-- 时间线配置表
CREATE TABLE `timeline_config` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `user_id` bigint NOT NULL COMMENT '用户ID',
  `display_activities` json COMMENT '显示的活动类型配置',
  `privacy_settings` json COMMENT '隐私设置',
  `notification_settings` json COMMENT '通知设置',
  `create_time` datetime DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

### 2.3 API设计规范

#### 2.3.1 RESTful API规范
```
HTTP方法映射:
GET    /api/v1/resources         # 获取资源列表
GET    /api/v1/resources/{id}    # 获取单个资源
POST   /api/v1/resources         # 创建资源
PUT    /api/v1/resources/{id}    # 更新资源(全量)
PATCH  /api/v1/resources/{id}    # 更新资源(部分)
DELETE /api/v1/resources/{id}    # 删除资源

状态码规范:
200 OK              # 请求成功
201 Created         # 创建成功
204 No Content      # 删除成功
400 Bad Request     # 请求参数错误
401 Unauthorized    # 未授权
403 Forbidden       # 禁止访问
404 Not Found       # 资源不存在
500 Internal Error  # 服务器内部错误
```

#### 2.3.2 统一响应格式
```java
// 成功响应
{
  "code": 200,
  "message": "success",
  "data": {...},
  "timestamp": 1642780800000
}

// 错误响应
{
  "code": 400,
  "message": "请求参数错误",
  "error": "validation failed",
  "timestamp": 1642780800000
}

// 分页响应
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [...],
    "total": 100,
    "current": 1,
    "size": 10,
    "pages": 10
  },
  "timestamp": 1642780800000
}
```

### 2.4 核心业务服务设计

#### 2.4.1 红花服务设计
```java
@Service
public class FlowerService {

    // 红花转账
    @Transactional
    public void transferFlowers(Long fromUserId, Long toUserId,
                               Integer amount, String remark) {
        // 1. 检查转出用户余额
        // 2. 扣减转出用户红花
        // 3. 增加转入用户红花
        // 4. 记录转账流水
        // 5. 发送通知消息
    }

    // 奖励红花
    @Transactional
    public void rewardFlowers(Long userId, Integer amount,
                             Long taskId, String description) {
        // 1. 增加用户红花余额
        // 2. 记录收入流水
        // 3. 更新任务状态
        // 4. 发送通知消息
    }

    // 消费红花
    @Transactional
    public void consumeFlowers(Long userId, Integer redFlowers,
                              Integer blackFlowers, Long rewardId) {
        // 1. 检查用户余额
        // 2. 优先扣减黑花
        // 3. 再扣减红花
        // 4. 记录消费流水
        // 5. 创建购买记录
    }
}
```

#### 2.4.2 任务执行服务设计
```java
@Service
public class TaskExecutionService {

    // 开始任务
    public void startTask(Long taskId, Long userId) {
        // 1. 创建执行记录
        // 2. 启动计时器(如果需要)
        // 3. 更新任务状态
        // 4. 发送开始通知
    }

    // 完成任务
    @Transactional
    public void completeTask(Long executionId, String proof) {
        // 1. 更新执行记录
        // 2. 停止计时器
        // 3. 待家长审核
        // 4. 发送完成通知
    }

    // 审核任务
    @Transactional
    public void verifyTask(Long executionId, Boolean approved,
                          String note, Long verifierId) {
        // 1. 更新审核状态
        // 2. 如果通过，发放红花奖励
        // 3. 更新循环任务下次执行时间
        // 4. 发送审核结果通知
    }
}
```

#### 2.4.3 班级管理服务设计
```java
@Service
public class ClassService {

    // 创建班级
    @Transactional
    public void createClass(ClassDTO classDTO) {
        // 1. 创建班级基本信息
        // 2. 分配班级红花池
        // 3. 设置班主任权限
        // 4. 发送创建通知
    }

    // 添加学生到班级
    @Transactional
    public void addStudentToClass(Long classId, Long studentId, String studentNumber) {
        // 1. 验证班级和学生信息
        // 2. 检查班级人数限制
        // 3. 创建班级成员记录
        // 4. 初始化学生班级红花账户
        // 5. 发送加入班级通知
    }

    // 创建学习小组
    @Transactional
    public void createStudyGroup(Long classId, GroupDTO groupDTO) {
        // 1. 验证班级权限
        // 2. 创建小组信息
        // 3. 添加小组成员
        // 4. 设置组长权限
        // 5. 发送小组创建通知
    }

    // 发布班级任务
    @Transactional
    public void publishClassTask(Long classId, TaskDTO taskDTO) {
        // 1. 验证任务权限
        // 2. 创建班级任务
        // 3. 分配给目标学生/小组
        // 4. 发送任务通知
        // 5. 记录活动日志
    }

    // 班级排名统计
    public ClassRankingVO getClassRanking(Long classId, String rankType) {
        // 1. 查询班级成员信息
        // 2. 统计红花数据
        // 3. 计算排名
        // 4. 生成排行榜
        return rankingVO;
    }
}
```

#### 2.4.4 成长日志服务设计
```java
@Service
public class GrowthLogService {

    // 记录活动日志
    @Async
    public void recordActivity(ActivityLogDTO logDTO) {
        // 1. 构建活动日志
        // 2. 保存到数据库
        // 3. 检查里程碑触发条件
        // 4. 更新成长统计
    }

    // 生成时间线
    public TimelineVO generateTimeline(Long userId, TimelineQuery query) {
        // 1. 查询用户活动记录
        // 2. 按时间排序
        // 3. 应用过滤条件
        // 4. 格式化输出
        return timelineVO;
    }

    // 检查并解锁里程碑
    @Transactional
    public void checkAndUnlockMilestone(Long userId, String milestoneType) {
        // 1. 获取用户统计数据
        // 2. 检查解锁条件
        // 3. 创建里程碑记录
        // 4. 发送解锁通知
        // 5. 记录活动日志
    }

    // 生成成长报告
    public GrowthReportVO generateGrowthReport(Long userId, String reportType,
                                             LocalDate startDate, LocalDate endDate) {
        // 1. 查询时间段内活动数据
        // 2. 统计各项指标
        // 3. 分析成长趋势
        // 4. 生成报告摘要
        // 5. 保存报告记录
        return reportVO;
    }

    // 导出成长报告PDF
    public byte[] exportGrowthReportPdf(Long userId, Long reportId) {
        // 1. 获取报告数据
        // 2. 生成PDF模板
        // 3. 填充数据
        // 4. 返回PDF字节流
        return pdfBytes;
    }
}
```
```

## 3. 技术实现方案

### 3.1 认证授权方案

#### 3.1.1 JWT Token设计
```java
// Token结构
{
  "sub": "用户ID",
  "username": "用户名",
  "role": "用户角色",
  "familyId": "家庭ID",
  "iat": "签发时间",
  "exp": "过期时间"
}

// 双Token机制
AccessToken:  有效期30分钟，用于API访问
RefreshToken: 有效期7天，用于刷新AccessToken
```

#### 3.1.2 权限控制设计
```java
// 基于角色的权限控制(RBAC)
@PreAuthorize("hasRole('PARENT') and @familyService.isFamilyMember(#familyId)")
public void createTask(@PathVariable Long familyId, @RequestBody TaskDTO dto) {
    // 只有家长且是家庭成员才能创建任务
}

// 数据权限控制
@DataPermission(type = "FAMILY", value = "#familyId")
public List<Task> getTasks(@PathVariable Long familyId) {
    // 只能查看自己家庭的任务
}
```

### 3.2 缓存策略设计

#### 3.2.1 Redis缓存分层
```java
// L1缓存 - 热点数据(TTL: 5分钟)
user:info:{userId}           // 用户基本信息
family:info:{familyId}       // 家庭基本信息
class:info:{classId}         // 班级基本信息

// L2缓存 - 业务数据(TTL: 30分钟)
flower:balance:{userId}      // 红花余额
task:list:{familyId}         // 家庭任务列表
class:tasks:{classId}        // 班级任务列表
class:members:{classId}      // 班级成员列表
group:members:{groupId}      // 小组成员列表

// L3缓存 - 统计数据(TTL: 2小时)
statistics:task:{userId}     // 任务完成统计
statistics:flower:{familyId} // 家庭红花统计
class:ranking:{classId}      // 班级排名数据
timeline:recent:{userId}     // 用户最近时间线
milestones:{userId}          // 用户里程碑列表

// L4缓存 - 报告数据(TTL: 24小时)
growth:report:{userId}:{date} // 成长报告缓存
class:statistics:{classId}    // 班级统计报告
```

#### 3.2.2 缓存更新策略
```java
@CacheEvict(value = "flower:balance", key = "#userId")
@CacheEvict(value = "statistics:flower", key = "#familyId")
public void updateFlowerBalance(Long userId, Long familyId) {
    // 更新余额时清除相关缓存
}

// 缓存预热
@EventListener(ApplicationReadyEvent.class)
public void preloadCache() {
    // 系统启动时预加载热点数据
}
```

### 3.3 消息队列设计

#### 3.3.1 消息队列拓扑
```
Exchange: flower.direct
├── Queue: flower.transaction    # 红花交易消息
├── Queue: flower.notification   # 红花通知消息
└── Queue: flower.statistics     # 红花统计消息

Exchange: task.topic
├── Queue: task.execution       # 任务执行消息
├── Queue: task.notification    # 任务通知消息
├── Queue: task.timer          # 任务计时消息
└── Queue: task.class          # 班级任务消息

Exchange: class.topic
├── Queue: class.ranking       # 班级排名消息
├── Queue: class.notification  # 班级通知消息
└── Queue: class.statistics    # 班级统计消息

Exchange: log.topic
├── Queue: log.activity        # 活动日志消息
├── Queue: log.milestone       # 里程碑消息
├── Queue: log.report          # 成长报告消息
└── Queue: log.timeline        # 时间线消息
```

#### 3.3.2 消息处理机制
```java
// 异步处理红花交易
@RabbitListener(queues = "flower.transaction")
public void handleFlowerTransaction(FlowerTransactionMessage message) {
    try {
        // 1. 更新账户余额
        // 2. 记录交易流水
        // 3. 发送通知消息
        // 4. 更新统计数据
    } catch (Exception e) {
        // 重试机制 + 死信队列
        throw new AmqpRejectAndDontRequeueException("处理失败", e);
    }
}

// 延时消息处理任务提醒
@RabbitListener(queues = "task.reminder")
public void handleTaskReminder(TaskReminderMessage message) {
    // 发送任务提醒通知
    notificationService.sendTaskReminder(message);
}

// 异步处理班级排名更新
@RabbitListener(queues = "class.ranking")
public void handleClassRanking(ClassRankingMessage message) {
    try {
        // 1. 重新计算班级排名
        // 2. 更新排行榜缓存
        // 3. 发送排名变化通知
        classService.updateRanking(message);
    } catch (Exception e) {
        log.error("处理班级排名更新失败", e);
    }
}

// 异步处理活动日志
@RabbitListener(queues = "log.activity")
public void handleActivityLog(ActivityLogMessage message) {
    try {
        // 1. 保存活动日志
        // 2. 检查里程碑触发
        // 3. 更新成长统计
        // 4. 生成时间线数据
        logService.processActivityLog(message);
    } catch (Exception e) {
        log.error("处理活动日志失败", e);
    }
}

// 异步处理里程碑解锁
@RabbitListener(queues = "log.milestone")
public void handleMilestone(MilestoneMessage message) {
    try {
        // 1. 创建里程碑记录
        // 2. 发送解锁通知
        // 3. 记录成就日志
        logService.unlockMilestone(message);
    } catch (Exception e) {
        log.error("处理里程碑解锁失败", e);
    }
}
```
```

### 3.4 第三方集成方案

#### 3.4.1 电商平台集成
```java
// 淘宝商品爬虫(仅用于展示，实际需要API授权)
@Service
public class TaobaoProductService {

    public ProductInfo getProductInfo(String url) {
        // 1. 解析商品URL
        // 2. 获取商品基本信息
        // 3. 下载商品图片到本地
        // 4. 返回标准化商品信息
    }

    // 京东商品信息获取
    public ProductInfo getJdProductInfo(String url) {
        // 类似实现
    }
}
```

#### 3.4.2 文件存储服务
```java
// 阿里云OSS集成
@Service
public class OssFileService {

    public String uploadFile(MultipartFile file, String path) {
        // 1. 生成唯一文件名
        // 2. 上传到OSS
        // 3. 返回访问URL
    }

    public void deleteFile(String url) {
        // 删除OSS文件
    }
}
```

## 4. 部署运维方案

### 4.1 Docker容器化

#### 4.1.1 Dockerfile示例
```dockerfile
# 后端服务Dockerfile
FROM openjdk:17-jre-slim

VOLUME /tmp
COPY target/red-flower-*.jar app.jar
EXPOSE 8080

ENV JAVA_OPTS="-Xms512m -Xmx1024m"
ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar /app.jar"]
```

#### 4.1.2 Docker Compose配置
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: red_flower
      MYSQL_ROOT_PASSWORD: password
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  nacos:
    image: nacos/nacos-server:latest
    environment:
      MODE: standalone
    ports:
      - "8848:8848"

  user-service:
    build: ./user-service
    ports:
      - "8081:8080"
    depends_on:
      - mysql
      - redis
      - nacos

  gateway:
    build: ./gateway
    ports:
      - "8080:8080"
    depends_on:
      - user-service

volumes:
  mysql_data:
```

### 4.2 监控告警

#### 4.2.1 应用监控指标
```yaml
# Prometheus监控指标
- JVM内存使用率
- GC频率和耗时
- 接口响应时间
- 接口错误率
- 数据库连接池使用率
- Redis连接数
- 消息队列堆积数量
```

#### 4.2.2 告警规则配置
```yaml
groups:
- name: red-flower-alerts
  rules:
  - alert: HighMemoryUsage
    expr: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.8
    for: 2m
    labels:
      severity: warning
    annotations:
      summary: "JVM内存使用率过高"

  - alert: HighErrorRate
    expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.1
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "接口错误率过高"
```

## 5. 性能优化方案

### 5.1 数据库优化

#### 5.1.1 索引设计
```sql
-- 用户表索引
CREATE INDEX idx_user_role ON user(role);
CREATE INDEX idx_user_status ON user(status);

-- 家庭成员索引
CREATE INDEX idx_family_member_family ON family_member(family_id);
CREATE INDEX idx_family_member_user ON family_member(user_id);

-- 红花交易索引
CREATE INDEX idx_flower_transaction_user_time ON flower_transaction(user_id, create_time);
CREATE INDEX idx_flower_transaction_type ON flower_transaction(type);

-- 任务索引
CREATE INDEX idx_task_assignee_status ON task(assignee_id, status);
CREATE INDEX idx_task_family_status ON task(family_id, status);

-- 任务执行索引
CREATE INDEX idx_task_execution_task_date ON task_execution(task_id, execution_date);
CREATE INDEX idx_task_execution_executor ON task_execution(executor_id);
```

#### 5.1.2 分表策略
```sql
-- 按月分表的交易记录
CREATE TABLE flower_transaction_202501 LIKE flower_transaction;
CREATE TABLE flower_transaction_202502 LIKE flower_transaction;

-- 分表路由规则
@Service
public class ShardingService {
    public String getTableSuffix(Date date) {
        return DateUtil.format(date, "yyyyMM");
    }
}
```

### 5.2 缓存优化

#### 5.2.1 多级缓存架构
```java
// L1: 本地缓存 (Caffeine)
@Cacheable(value = "localCache", cacheManager = "caffeineCacheManager")
public UserInfo getUserInfo(Long userId) {
    return userRepository.findById(userId);
}

// L2: 分布式缓存 (Redis)
@Cacheable(value = "redisCache", cacheManager = "redisCacheManager")
public List<Task> getFamilyTasks(Long familyId) {
    return taskRepository.findByFamilyId(familyId);
}
```

#### 5.2.2 缓存预热和更新
```java
// 启动时预热热点数据
@EventListener(ApplicationReadyEvent.class)
public void warmUpCache() {
    // 预热活跃用户数据
    List<Long> activeUsers = statisticsService.getActiveUsers();
    activeUsers.forEach(userId -> {
        userService.getUserInfo(userId);
        flowerService.getBalance(userId);
    });
}

// 异步更新缓存
@Async
public void updateCacheAsync(String cacheKey, Object data) {
    redisTemplate.opsForValue().set(cacheKey, data, Duration.ofMinutes(30));
}
```

## 6. 安全方案

### 6.1 数据安全

#### 6.1.1 敏感数据加密
```java
// 用户密码加密
@Service
public class PasswordService {

    public String encodePassword(String rawPassword) {
        return BCrypt.hashpw(rawPassword, BCrypt.gensalt(12));
    }

    public boolean matches(String rawPassword, String encodedPassword) {
        return BCrypt.checkpw(rawPassword, encodedPassword);
    }
}

// 手机号脱敏
public String maskPhone(String phone) {
    if (StringUtils.isBlank(phone) || phone.length() < 7) {
        return phone;
    }
    return phone.substring(0, 3) + "****" + phone.substring(7);
}
```

#### 6.1.2 API安全防护
```java
// 接口限流
@RateLimiter(name = "api", fallbackMethod = "rateLimitFallback")
public ResponseEntity<?> createTask(@RequestBody TaskDTO dto) {
    return ResponseEntity.ok(taskService.createTask(dto));
}

// SQL注入防护
@Query("SELECT t FROM Task t WHERE t.familyId = :familyId AND t.status = :status")
List<Task> findByFamilyIdAndStatus(@Param("familyId") Long familyId,
                                  @Param("status") TaskStatus status);

// XSS防护
@Component
public class XssFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response,
                        FilterChain chain) throws IOException, ServletException {
        XssHttpServletRequestWrapper wrappedRequest =
            new XssHttpServletRequestWrapper((HttpServletRequest) request);
        chain.doFilter(wrappedRequest, response);
    }
}
```

### 6.2 隐私保护

#### 6.2.1 数据权限控制
```java
// 基于数据权限的查询
@DataPermission(type = "FAMILY")
@Query("SELECT t FROM Task t WHERE t.familyId IN :familyIds")
List<Task> findTasksByDataPermission(@Param("familyIds") List<Long> familyIds);

// 儿童隐私保护
@ChildDataProtection
public class ChildController {

    @GetMapping("/profile")
    public ResponseEntity<ChildProfile> getProfile(Authentication auth) {
        // 只返回必要的个人信息，隐藏敏感数据
        return ResponseEntity.ok(childService.getProtectedProfile(auth.getName()));
    }
}
```

---

**文档版本**: v1.1
**创建日期**: 2025-09-19
**更新日期**: 2025-09-19
**负责人**: 技术团队
**更新内容**: 新增班级管理、多孩子管理、成长日志功能的技术实现